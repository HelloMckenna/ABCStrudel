<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ABC â†’ Strudel Converter</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #f9fafb;
      color: #222;
      margin: 2em auto;
      max-width: 900px;
      line-height: 1.6;
    }
    h1 { text-align: center; }
    textarea {
      width: 100%;
      height: 240px;
      font-family: monospace;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #bbb;
      resize: vertical;
      box-sizing: border-box;
    }
    select, button {
      margin-top: 10px;
      padding: 10px 15px;
      border-radius: 6px;
      border: 1px solid #bbb;
      background: #fff;
      cursor: pointer;
      font-weight: 600;
    }
    button {
      background: #0072ff;
      color: white;
      border: none;
    }
    button:hover { background: #005fd1; }
    pre {
      background: #111;
      color: #0f0;
      padding: 15px;
      border-radius: 8px;
      white-space: pre-wrap;
      overflow-x: auto;
      font-size: 0.9rem;
    }
    .footer {
      margin-top: 3em;
      text-align: center;
      font-size: 0.8rem;
      color: #666;
    }
  </style>
</head>
<body>
  <h1>ðŸŽµ ABC â†’ Strudel Converter</h1>
  <p>
    Paste your <a href="https://abcnotation.com/learn" target="_blank">ABC notation</a> below and click
    <b>Convert</b> to generate playable <a href="https://strudel.cc" target="_blank">Strudel</a> code.
  </p>

  <textarea id="abcInput" placeholder="Paste ABC here..."></textarea>
  <br>

  <label for="sound">Sound:</label>
  <select id="sound">
    <option value="piano">piano</option>
    <option value="pluck">pluck</option>
    <option value="saw">saw</option>
    <option value="bass">bass</option>
    <option value="synth">synth</option>
    <option value="drum">drum</option>
  </select>

  <button onclick="convertABC()">Convert</button>

  <h2>Generated Strudel Code:</h2>
  <pre id="strudelOutput"></pre>

  <div class="footer">Built for traditional musicians & live coders ðŸŽ»</div>

  <script>
    // Basic chromatic map
    const baseMap = {
      'C': 'c', '^C': 'c#', '_C': 'cb',
      'D': 'd', '^D': 'd#', '_D': 'db',
      'E': 'e', '^E': 'e#', '_E': 'eb',
      'F': 'f', '^F': 'f#', '_F': 'fb',
      'G': 'g', '^G': 'g#', '_G': 'gb',
      'A': 'a', '^A': 'a#', '_A': 'ab',
      'B': 'b', '^B': 'b#', '_B': 'bb'
    };

    // Major key accidental templates (adds sharps/flats automatically)
    const keyAccidentals = {
      // Major keys
      'Cmaj': [],
      'Gmaj': ['F#'],
      'Dmaj': ['F#', 'C#'],
      'Amaj': ['F#', 'C#', 'G#'],
      'Emaj': ['F#', 'C#', 'G#', 'D#'],
      'Bmaj': ['F#', 'C#', 'G#', 'D#', 'A#'],
      'Fmaj': ['Bb'],
      'Bbmaj': ['Bb', 'Eb'],
      'Ebmaj': ['Bb', 'Eb', 'Ab'],
      'Abmaj': ['Bb', 'Eb', 'Ab', 'Db'],

      // Natural minor keys (relative to major)
      'Amin': [],
      'Emin': ['F#'],
      'Bmin': ['F#', 'C#'],
      'F#min': ['F#', 'C#', 'G#'],
      'C#min': ['F#', 'C#', 'G#', 'D#'],
      'G#min': ['F#', 'C#', 'G#', 'D#', 'A#'],
      'Dmin': ['Bb'],
      'Gmin': ['Bb', 'Eb'],
      'Cmin': ['Bb', 'Eb', 'Ab'],
      'Fmin': ['Bb', 'Eb', 'Ab', 'Db'],

      // Dorian mode (one flat less than the relative minor, or one sharp more than relative major)
      'Ador': ['F#'],
      'Edor': ['F#', 'C#'],
      'Bdor': ['F#', 'C#', 'G#'],
      'F#dor': ['F#', 'C#', 'G#', 'D#'],
      'C#dor': ['F#', 'C#', 'G#', 'D#', 'A#'],
      'G#dor': ['F#', 'C#', 'G#', 'D#', 'A#', 'E#'],
      'Ddor': [],
      'Gdor': ['Bb'],
      'Cdor': ['Bb', 'Eb'],
      'Fdor': ['Bb', 'Eb', 'Ab'],

      // Mixolydian mode (one flat more than relative major, or one sharp less than relative major)
      'Amix': ['F#', 'C#'],
      'Emix': ['F#', 'C#','G#'],
      'Bmix': ['F#', 'C#','G#', 'D#'],
      'F#mix': ['F#', 'C#','G#', 'D#', 'A#'],
      'C#mix': ['F#', 'C#','G#', 'D#', 'A#', 'E#'],
      'G#mix': ['F#', 'C#','G#', 'D#', 'A#', 'E#', 'B#'],
      'Dmix': ['F#'],
      'Gmix': [],
      'Cmix': ['Bb'],
      'Fmix': ['Bb', 'Eb']
    };

    function parseHeader(lines) {
      const header = {};
      for (const line of lines) {
        if (/^T:/.test(line)) header.title = line.replace(/^T:\s*/, '');
        if (/^R:/.test(line)) header.rhythm = line.replace(/^R:\s*/, '');
        if (/^M:/.test(line)) header.meter = line.replace(/^M:\s*/, '');
        if (/^L:/.test(line)) header.length = line.replace(/^L:\s*/, '');
        if (/^K:/.test(line)) header.key = line.replace(/^K:\s*/, '').replace(/\s+/g, '');
      }
      return header;
    }

    // Expand |: ... :| â†’ [section]*2
    function markRepeats(body) {
      return body.replace(/\|:\s*([^:]+?)\s*:\|/g, (m, section) => `[${section.trim()}]*2`);
    }

    function splitBars(abc) {
      return abc
        .replace(/[{}~]/g, '') // ornaments
        .replace(/\([0-9]/g, '') // triplets
        .replace(/::/g, ':')
        .replace(/\n/g, ' ')
        .replace(/\s+/g, ' ')
        .trim()
        .split('|')
        .map(b => b.trim())
        .filter(Boolean);
    }

    // Improved accidental logic
    function parseNotes(bar, key) {
      const accidentals = keyAccidentals[key] || [];
      const tokens = bar.match(/[_^]?[A-Ga-g][',]?[0-9]*/g) || [];

      return tokens.map(tok => {
        let dur = tok.match(/[0-9]+/);
        let len = dur ? `@${dur[0]}` : '';
        tok = tok.replace(/[0-9]/g, '');
        let acc = '';
        if (tok.startsWith('^')) acc = '^', tok = tok.slice(1);
        else if (tok.startsWith('_')) acc = '_', tok = tok.slice(1);

        const noteLetter = tok[0].toUpperCase();

        // Apply key signature sharps/flats if no explicit accidental
        if (!acc) {
          for (const accidental of accidentals) {
            if (accidental[0].toUpperCase() === noteLetter) {
              if (accidental[1] === '#') acc = '^';
              if (accidental[1] === 'b') acc = '_';
            }
          }
        }

        let octave = /[a-g]/.test(tok[0]) ? 5 : 4;
        if (tok.includes("'")) octave++;
        if (tok.includes(",")) octave--;

        const base = baseMap[acc + noteLetter] || tok[0].toLowerCase();
        return `${base}${octave}${len}`;
      }).join(' ');
    }

    function convertABC() {
      const input = document.getElementById('abcInput').value.trim();
      const sound = document.getElementById('sound').value;
      if (!input) return;

      const lines = input.split('\n');
      const header = parseHeader(lines);
      const bodyStart = lines.findIndex(l => /^K:/.test(l));
      let body = lines.slice(bodyStart + 1).join(' ');
      body = markRepeats(body);

      // Split bars but preserve [ ... ]*2 as repeat blocks
      const repeatBlocks = [];
      const regex = /\[([^*]+)\]\*2/g;
      let match, lastIndex = 0;
      while ((match = regex.exec(body)) !== null) {
        const before = body.slice(lastIndex, match.index).trim();
        if (before) repeatBlocks.push(...splitBars(before));
        repeatBlocks.push({ repeat: true, content: match[1].trim() });
        lastIndex = regex.lastIndex;
      }
      const tail = body.slice(lastIndex).trim();
      if (tail) repeatBlocks.push(...splitBars(tail));

      const formattedBars = repeatBlocks.map(b => {
        if (typeof b === 'object' && b.repeat) {
          const innerBars = splitBars(b.content).map(inner => `[${parseNotes(inner, header.key)}]`).join(' ');
          return `${innerBars}*2`;
        } else {
          return `[${parseNotes(b, header.key)}]`;
        }
      }).join('\n');

      const output =
`// ${header.title || 'Untitled'}
// ${header.meter || ''} ${header.rhythm || ''}
// ${header.key || ''}
// ${header.length || ''} notes
setcpm(1)

$: note(\`
${formattedBars}
\`).sound("${sound}")`;

      document.getElementById('strudelOutput').textContent = output;
    }
  </script>
</body>
</html>